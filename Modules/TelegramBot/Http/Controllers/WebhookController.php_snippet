<?php
// ... (existing code)

    /**
     * Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³Ø±ÙˆÛŒØ³ Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ QR Code (Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ†ÛŒ)
     */
    protected function showServiceDetailsWithQR($user, $orderId, $messageId = null)
    {
        // 1. Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ù‚Ø¨Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø¢Ù† Ø±Ø§ Ø­Ø°Ù Ú©Ù† (Ú†ÙˆÙ† Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ Ø¹Ú©Ø³ ØªØ¨Ø¯ÛŒÙ„ Ú©Ø±Ø¯)
        if ($messageId) {
            try {
                Telegram::deleteMessage([
                    'chat_id' => $user->telegram_chat_id,
                    'message_id' => $messageId
                ]);
            } catch (\Exception $e) {
                // Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ù‚Ø¨Ù„Ø§Ù‹ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ù…Ø´Ú©Ù„ÛŒ Ù†ÛŒØ³Øª
            }
        }

        // 2. ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ QR Code + Ø¬Ø²Ø¦ÛŒØ§Øª
        // Ø¯Ø± ÙˆØ§Ù‚Ø¹ Ø§Ø² Ù‡Ù…Ø§Ù† Ù„Ø§Ø¬ÛŒÚ© sendQRCodeForOrder Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø§Ù…Ø§ Ø¨Ø§ Ú©Ù¾Ø´Ù† Ú©Ø§Ù…Ù„â€ŒØªØ±
        
        $order = $user->orders()->with('plan')->find($orderId);

        if (!$order || !$order->plan || $order->status !== 'paid') {
            $this->sendOrEditMainMenu($user->telegram_chat_id, "âŒ Ø³Ø±ÙˆÛŒØ³ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.", null);
            return;
        }

        // Ø§Ú¯Ø± Ú©Ø§Ù†ÙÛŒÚ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ù‡Ù…Ø§Ù† Ù…ØªÙ† Ø³Ø§Ø¯Ù‡ Ø±Ø§ Ø¨ÙØ±Ø³Øª
        if (empty($order->config_details)) {
             $this->showServiceDetails($user, $orderId, null);
             return;
        }

        // Ø³Ø§Ø®Øª QR Code Ùˆ Ø§Ø±Ø³Ø§Ù„
        // Ú©Ø¯ Ø²ÛŒØ± ØªØ±Ú©ÛŒØ¨ÛŒ Ø§Ø² showServiceDetails Ùˆ sendQRCodeForOrder Ø§Ø³Øª
        
        $configLink = trim($order->config_details);
        $panelUsername = $order->panel_username ?: "user-{$user->id}-order-{$order->id}";
        $expiresAt = Carbon::parse($order->expires_at);
        $now = now();
        $daysRemaining = (int) $now->diffInDays($expiresAt, false);
        
        if ($expiresAt->isPast()) {
            $remainingText = "*Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡*";
            $statusIcon = 'âš«ï¸';
        } elseif ($daysRemaining <= 7) {
            $remainingText = "*{$daysRemaining} Ø±ÙˆØ²* Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ (ØªÙ…Ø¯ÛŒØ¯ Ú©Ù†ÛŒØ¯)";
            $statusIcon = 'ğŸŸ¡';
        } else {
            $remainingText = "*{$daysRemaining} Ø±ÙˆØ²* Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡";
            $statusIcon = 'ğŸŸ¢';
        }

        $locationFlag = 'ğŸ³ï¸';
        $locationName = 'Ù†Ø§Ù…Ø´Ø®Øµ';
        $panelType = $this->settings->get('panel_type');
        if ($order->plan && ($panelType === 'pasargad' || !$panelType)) {
             $locationFlag = 'ğŸ¦…';
             $locationName = 'Ø³Ø±ÙˆÛŒØ³ Eagle';
        }

        // Ù…ØªÙ† Ú©Ù¾Ø´Ù† (Ù…Ø´Ø§Ø¨Ù‡ showServiceDetails)
        $caption = "ğŸ” *Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ø´ØªØ±Ø§Ú© \\#{$order->id}*\n";
        $caption .= "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
        $caption .= "ğŸ’ *Ø³Ø±ÙˆÛŒØ³:* " . $this->escape($order->plan->name) . "\n";
        $caption .= "ğŸŒ *Ù…ÙˆÙ‚Ø¹ÛŒØª:* {$locationFlag} " . $this->escape($locationName) . "\n";
        $caption .= "ğŸ‘¤ *Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ:* `" . $this->escapeCode($panelUsername) . "`\n";
        $caption .= "ğŸ—“ *Ø§Ù†Ù‚Ø¶Ø§:* " . $this->escape($expiresAt->format('Y/m/d')) . "\n";
        $caption .= "â± *ÙˆØ¶Ø¹ÛŒØª:* " . $this->escape($remainingText) . "\n"; // remainingText Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³Ú©ÛŒÙ¾ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŸ Ú†Ú© Ú©Ù†ÛŒÙ…
        // Ù†Ù‡ØŒ remainingText Ø¯Ø³ØªÛŒ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ù¾Ø³ Ø¨Ø§ÛŒØ¯ Ù…Ø±Ø§Ù‚Ø¨ Ø¨Ø§Ø´ÛŒÙ…. Ø¨Ù‡ØªØ±Ù‡ Ø§Ø² Ù†Ùˆ Ø¨Ø³Ø§Ø²ÛŒÙ…:
        if ($expiresAt->isPast()) $remainingTextSafe = "*Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡*";
        else $remainingTextSafe = "*" . $this->escape($daysRemaining . ' Ø±ÙˆØ²') . "* Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡";
        
        // Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø®Ø· ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§ Ø§Ø³Ú©ÛŒÙ¾ ØµØ­ÛŒØ­
        $caption = str_replace("â± *ÙˆØ¶Ø¹ÛŒØª:* " . $this->escape($remainingText) . "\n", "â± *ÙˆØ¶Ø¹ÛŒØª:* " . $remainingTextSafe . "\n", $caption);


        $caption .= "ğŸ“¦ *Ø­Ø¬Ù… Ú©Ù„:* " . $this->escape($order->plan->volume_gb . ' Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª') . "\n\n";
        $caption .= "ğŸ”— *Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú© Ø§Ø®ØªØµØ§ØµÛŒ:*\n";
        $caption .= "`" . $this->escapeCode($configLink) . "`\n\n";
        $caption .= "ğŸ‘†ğŸ» " . $this->escape("Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ Ø³Ø±ÛŒØ¹ Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ø¨Ø§Ù„Ø§ Ø¨Ø²Ù†ÛŒØ¯!") . "\n";

        // Ú©ÛŒØ¨ÙˆØ±Ø¯
        $keyboard = Keyboard::make()->inline();
        $keyboard->row([
            Keyboard::inlineButton(['text' => "ğŸ“‹ Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©", 'callback_data' => "copy_link_{$order->id}"])
        ]);
        $keyboard->row([
            Keyboard::inlineButton(['text' => "ğŸ”„ ØªÙ…Ø¯ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©", 'callback_data' => "renew_order_{$order->id}"])
        ]);
        $keyboard->row([
            Keyboard::inlineButton(['text' => 'â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§', 'callback_data' => '/my_services']),
            Keyboard::inlineButton(['text' => 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', 'callback_data' => '/start'])
        ]);

        // ØªÙˆÙ„ÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ QR
        $tempFile = null;
        try {
            $qrParams = [
                'size' => '400x400',
                'data' => $configLink,
                'ecc' => 'M',
                'margin' => 10,
                'color' => '000000',
                'bgcolor' => 'FFFFFF',
                'format' => 'png'
            ];
            $qrUrl = "https://api.qrserver.com/v1/create-qr-code/?" . http_build_query($qrParams);
            
            // Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„
            $ch = curl_init();
            curl_setopt_array($ch, [
                CURLOPT_URL => $qrUrl,
                CURLOPT_RETURNTRANSFER => true,
                CURLOPT_TIMEOUT => 10
            ]);
            $qrData = curl_exec($ch);
            curl_close($ch);

            if (!$qrData) throw new \Exception("Empty QR Data");

            $tempDir = storage_path('app/temp');
            if (!is_dir($tempDir)) mkdir($tempDir, 0755, true);
            $tempFile = $tempDir . '/qr_' . $order->id . '_' . time() . '.png';
            file_put_contents($tempFile, $qrData);

            Telegram::sendPhoto([
                'chat_id' => $user->telegram_chat_id,
                'photo' => InputFile::create($tempFile, "qr_{$order->id}.png"),
                'caption' => $caption,
                'parse_mode' => 'MarkdownV2',
                'reply_markup' => $keyboard
            ]);

        } catch (\Exception $e) {
            Log::error("QR Auto-Send Failed: " . $e->getMessage());
            // ÙØ§Ù„â€ŒØ¨Ú© Ø¨Ù‡ Ù…ØªÙ† Ù…Ø¹Ù…ÙˆÙ„ÛŒ
            $this->showServiceDetails($user, $orderId, null); // null messageId to force new message
        } finally {
            if ($tempFile && file_exists($tempFile)) @unlink($tempFile);
        }
    }
